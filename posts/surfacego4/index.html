<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Déployer Windows 10 Sur une Surface Go 4 - Loonaire Blog</title>
<meta name=description content="Il y a peu j&rsquo;ai du déployer Windows 10 sur des Surface Go 4, de manière générale Windows 10 sur les Surface Go 4 c&rsquo;est compliqué, et au dela des Surface Go 4, cet article s&rsquo;étend aux appareils qui utilisent la mémoire UFS.
s
Le fonctionnement du MDT
Avant de commencer, un rapide brief sur le MDT, il se compose de 3 composants distincts:
- Le serveur WDS qui est le serveur qui acceptera les connexions et qui va contenir l&rsquo;image de démarrage pour le déploiement
- L&rsquo;outil MDT qui est la console Deployment Workbench qui permet de générer l&rsquo;image de démarrage du déploiement ainsi que la séquence de tâches à executer, les fichiers résultants sont stockés dans un répertoire partagés
- Le composant ADK + le module ADK winPE (à partir de windows 10 de 2019) qui sont les fichiers qui permettent la génération d&rsquo;image de boot winPE"><meta name=author content><link href=https://unpkg.com/@master/normal.css rel=stylesheet><script src=https://unpkg.com/@master/style@1.5.0></script><script src=https://unpkg.com/@master/styles@1.13.0></script><script src=https://unpkg.com/master-styles-group></script><script src=https://unpkg.com/themes.js></script><script>window.themes=window.themes||new window.Themes</script></head><body class="bg:fade-84@dark font:fade-16@dark"><nav class="w:full h:90 fixed bg:fade-84/.95@dark bg:white z:1000"><div class="h:full
w:full
max-w:1200
mx:auto
px:32
d:flex
align-items:center"><div><a href=../../ class="mr-3 font:extralight">Loonaire Blog</a></div><div class=ml:auto><a class="font:semibold
font:fade
font:fade-10:hover
font:fade-30.active
px:8
transition:150ms;ease-in" href=../../posts/ title>Articles</a>
<a class="font:semibold
font:fade
font:fade-10:hover
font:fade-30.active
px:8
transition:150ms;ease-in" href=../../other/ title>Autre contenu</a>
<a class="font:semibold
font:fade
font:fade-10:hover
font:fade-30.active
px:8
transition:150ms;ease-in" href=../../about title>A propos</a></div></div></nav><div class="d:flex flex:column@<=sm pt:90 px:24 jc:center gap:44 word-break:break-word"><div class="max-w:700 w:full box:content-box"><article class="box:border-box pt:32"><header class=mb:32><div class="font:40 font:extrabold">Déployer Windows 10 Sur une Surface Go 4</div><div class="mt:16 f:fade-60"><time>27 janv. 2024</time></div></header><div class="_:where(a):hover{text-decoration-color:fade}
_:where(a){text-decoration:2;underline;fade-10;_text-decoration-color:fade-70@dark}
_:where(blockquote){bl:5;solid;fade-76/.1;_bl:5;solid;fade-34/.1@dark}
_:where(code){font:90%;_v:middle}
_:where(code:not(.highlight_*,pre_*)){p:2;6;_r:4}
_:where(del){text-decoration:1;line-through;fade-68;_text-decoration-color:red-64@dark}
_:where(figcaption){text:14;_p:10;20;0;_width:fit;_mx:auto;_font:fade-56;_font:fade-57@dark}
_:where(h1){font:40;_font:extrabold}
_:where(h1,h2,h3)+:where(h1,h2,h3){mt:.5em}
_:where(h1,h2,h3,h4,h5,h6){mt:2em}
_:where(h2){mb:1em;_font:32}
_:where(h3){font:24}
_:where(h4){font:20}
_:where(h5){font:16}
_:where(h6){font:14}
_:where(li)::marker{font:fade-44;_font:fade-68@dark}
_:where(li){pl:.375em}
_:where(mark){text-decoration:1;underline;#fce016;_bg:transparent;_text-decoration-color:rgb(252;224;22/.5)@dark}
_:where(p,li){font:fade-76;_font:16;_line-height:1.65;_font:fade-34@dark}
_:where(p,pre,blockquote,figure,ul,ol,table){my:1.125em}
>:first-child{mt:0!}
_:where(pre){p:20;_r:8;_overflow:auto}
_:where(pre,code:not(.highlight_*)){bg:fade-2;_bg:fade-92!@dark}
_:where(strong,b,a,code:not(.highlight_*),mark,del){font:fade-92;_font:fade-12@dark}
_:where(table){width:full;_border-spacing:0}
_:where(td){v:baseline}
_:where(td,th):first-child{pl:0}
_:where(td,th):last-child{pr:0}
_:where(td,th){bb:1;solid;fade-92/.06;_p:6;_b:fade-4/.04@dark}
_:where(th){font:fade-78;_font:14;_text:left;_font:fade-12@dark}
_:where(th,p_code,li_code,a,mark){font:semibold;_font:medium@dark}
_:where(ul){list-style-type:disc}
_:where(ul,ol,blockquote){pl:1.5em}
_:where(video,img){max-width:full}
_:where(a,mark){text-underline-offset:3}"><p>Il y a peu j&rsquo;ai du déployer Windows 10 sur des Surface Go 4, de manière générale Windows 10 sur les Surface Go 4 c&rsquo;est compliqué, et au dela des Surface Go 4, cet article s&rsquo;étend aux appareils qui utilisent la mémoire UFS.
s</p><h2 id=le-fonctionnement-du-mdt>Le fonctionnement du MDT</h2><p>Avant de commencer, un rapide brief sur le MDT, il se compose de 3 composants distincts:
- Le serveur WDS qui est le serveur qui acceptera les connexions et qui va contenir l&rsquo;image de démarrage pour le déploiement
- L&rsquo;outil MDT qui est la console Deployment Workbench qui permet de générer l&rsquo;image de démarrage du déploiement ainsi que la séquence de tâches à executer, les fichiers résultants sont stockés dans un répertoire partagés
- Le composant ADK + le module ADK winPE (à partir de windows 10 de 2019) qui sont les fichiers qui permettent la génération d&rsquo;image de boot winPE</p><p>Comment ca marche?</p><p>Le MDT crée un dossier partagé, la console Deployment Workbench permet de gérer ce dossier, ici sera importé ce que l&rsquo;on souhaitera installer et faire, il faut importer les drivers, l&rsquo;os et les logiciels à installer. Une séquence de tâche liée au contenu du partage sera mise en place.</p><p>Une fois en place, il faut générer une image de déploiement dans la console, cette génération va faire appel aux fichier installés par l&rsquo;ADK, une image de démarrage liteTouch sera crée.</p><p>Enfin, sur le serveur WDS, il faut importer l&rsquo;image liteTouch de démarrage, ensuite sur les ordinateurs client, il faut démarrer en PXE et l&rsquo;image de démarrage se chargera automatiquement et utilisera la séquence de tâche présente dans le dossier de partage du MDT. A noter que la modification de la séquence de tâches ainsi que l&rsquo;ajout de contenu dans le partage du MDT n&rsquo;implique pas forcément une mise à jour de l&rsquo;image de démarrage.</p><h2 id=windows-sur-les-surface-go-4>Windows sur les Surface Go 4</h2><p>Ces tablettes sont prévues pour Windows 11 en priorité mais dans mon cas, Windows 10 et 11 sont dans le même bâteau. Ces Surface utilisent de la mémoire UFS et le pilote de cette mémoire n&rsquo;est pas fourni avec le package de driver de la tablette, en plus seules les iso de Windows 10 et 11 à partir de la version 22H2 de octobre 2023 intègrent ce driver.</p><h2 id=le-déploiement>Le déploiement</h2><h3 id=les-causes>Les causes</h3><p>Le déploiement via MDT sur les Surfaces Go 4 viens du pilote du stockage de l&rsquo;image de boot winPE, la plupart du temps les images winPE d&rsquo;installation ne sont jamais mises à jour car le Windows ADK n&rsquo;est pas mis à jour. De plus, la dernière version de windows ADK à supporter le 32bit est la version 2004.</p><h3 id=la-solution>La solution</h3><p>La solution est de mettre à jour le serveur et le kit ADK + mise en place d&rsquo;un iso avec une image d&rsquo;octobre 2023 au minimum + regénération de l&rsquo;image de démarrage. La solution est disponible dans les parties suivantes</p><h3 id=le-serveur-wds>Le serveur WDS</h3><p>Avant de commencer les modifications, le serveur WDS doit être fonctionnel, si il n&rsquo;est pas fonctionnel et indiquer en rouge, il faut peux être le réinitialiser avec les commandes (<a href=https://www.raytechnote.com/wds-server-not-working-after-in-place-upgrade-from-windows-2012-to-windows-2019/>source</a>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-batch data-lang=batch><span style=display:flex><span>wdsutil /uninitialize-server 
</span></span><span style=display:flex><span>wdsutil /Initialize-Server /RemInst:C:\RemoteInstall 
</span></span></code></pre></div><p>Puis passer l&rsquo;écoute AnswerClients via set-server en ALL ou Known:</p><pre tabindex=0><code>wdsutil /Set-Server /AnswerClients:All
</code></pre><h3 id=ladk>L&rsquo;ADK</h3><p>L&rsquo;ADK pour le déploiement d&rsquo;images Windows est un sujet qui deviens compliqué: sur les versions sorties après la version 2004 l&rsquo;ADK à beaucoup de bug.<br>La meilleure solution est à mon avis de mettre à jour l&rsquo;ADK sur la version 22H2, si vous n&rsquo;avez pas besoin de déployer du 32bits il s&rsquo;agit de la solution la plus simple. A noter également que la version 2023 possède plusieurs bug, un premier concerne l&rsquo;absence de VBSCRIPT en fonctionnalité (voir détails plus bas) et un autre provienais de ZTIDrivers lors de mes tests, il s&rsquo;agit de la version avec le plus de bug.</p><h4 id=mettre-à-jour-ladk-vers-la-version-22h2>Mettre à jour l&rsquo;ADK vers la version 22H2</h4><p>Pour mettre à jour l&rsquo;ADK vers la version 22H2, il faut désinstaller l&rsquo;ancienne version et installer la nouvelle qui est disponible sur <a href=https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install#other-adk-downloads>cette page du support Microsoft</a>. A l&rsquo;issu de cette installation, il faudra regénérer complètement l&rsquo;image de démarrage dans la console DeploymentWorkbench.</p><p>Une fois fait, il faut regénérer une image de démarrage dans la console MDT et l&rsquo;importer dans les images de démarrage du server WDS</p><h4 id=corriger-le-bug-des-propriétés-de-winpe-dans-la-console-deployment-workbench>Corriger le bug des propriétés de winPE dans la console Deployment Workbench</h4><p>Ce bug est genant de viens du retrait de l&rsquo;architecture 32bits dans l&rsquo;ADK Windows, il est présent à partir des version suivants la version 2004 de l&rsquo;ADK.</p><p>Pour le corriger, il faut créer le dossier <code>C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\x86\WinPE_OCs</code> dans les dossiers de l&rsquo;ADK, voici une commande pour le faire automatiquement:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-batch data-lang=batch><span style=display:flex><span><span style=color:#66d9ef>mkdir</span> C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\x86\WinPE_OCs
</span></span></code></pre></div><p><a href=https://learn.microsoft.com/en-us/answers/questions/758014/deployment-workbench-crashes-when-opening-the-win>Source de la résolution du problème</a></p><h4 id=corriger-les-bugs-de-ladk-22h2>Corriger les bugs de l&rsquo;ADK 22H2</h4><h5 id=le-problème-du-script-qui-ne-répond-pas>Le problème du script qui ne répond pas</h5><p>L&rsquo;ADK 22H2 provoquera un problème au moment de saisir les paramètres de déploiement, il y aura des fenêtres indiquant qu&rsquo;il y a un problème lors de l&rsquo;execution du script.
La correction est simple et fournie par Microsoft <a href=https://learn.microsoft.com/fr-fr/mem/configmgr/mdt/known-issues#hta-applications-report-script-error-after-upgrading-to-adk-for-windows-11-version-22h2>ici</a></p><p>Il faut modifier le fichier <code>C:\Program Files\Microsoft Deployment Toolkit\Templates\Unattend_PE_x64.xml</code> et remplacer son contenu par:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;unattend</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;urn:schemas-microsoft-com:unattend&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;settings</span> <span style=color:#a6e22e>pass=</span><span style=color:#e6db74>&#34;windowsPE&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;component</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;Microsoft-Windows-Setup&#34;</span> <span style=color:#a6e22e>processorArchitecture=</span><span style=color:#e6db74>&#34;amd64&#34;</span> <span style=color:#a6e22e>publicKeyToken=</span><span style=color:#e6db74>&#34;31bf3856ad364e35&#34;</span> <span style=color:#a6e22e>language=</span><span style=color:#e6db74>&#34;neutral&#34;</span> <span style=color:#a6e22e>versionScope=</span><span style=color:#e6db74>&#34;nonSxS&#34;</span> <span style=color:#a6e22e>xmlns:wcm=</span><span style=color:#e6db74>&#34;http://schemas.microsoft.com/WMIConfig/2002/State&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;Display&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;ColorDepth&gt;</span>32<span style=color:#f92672>&lt;/ColorDepth&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;HorizontalResolution&gt;</span>1024<span style=color:#f92672>&lt;/HorizontalResolution&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;RefreshRate&gt;</span>60<span style=color:#f92672>&lt;/RefreshRate&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;VerticalResolution&gt;</span>768<span style=color:#f92672>&lt;/VerticalResolution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/Display&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;RunSynchronous&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;RunSynchronousCommand</span> <span style=color:#a6e22e>wcm:action=</span><span style=color:#e6db74>&#34;add&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;Description&gt;</span>Lite Touch PE<span style=color:#f92672>&lt;/Description&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;Order&gt;</span>1<span style=color:#f92672>&lt;/Order&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;Path&gt;</span>reg.exe add &#34;HKLM\Software\Microsoft\Internet Explorer\Main&#34; /t REG_DWORD /v JscriptReplacement /d 0 /f<span style=color:#f92672>&lt;/Path&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/RunSynchronousCommand&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;RunSynchronousCommand</span> <span style=color:#a6e22e>wcm:action=</span><span style=color:#e6db74>&#34;add&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;Description&gt;</span>Lite Touch PE<span style=color:#f92672>&lt;/Description&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;Order&gt;</span>2<span style=color:#f92672>&lt;/Order&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;Path&gt;</span>wscript.exe X:\Deploy\Scripts\LiteTouch.wsf<span style=color:#f92672>&lt;/Path&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/RunSynchronousCommand&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/RunSynchronous&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/component&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/settings&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/unattend&gt;</span>
</span></span></code></pre></div><p><strong>Il faut ensuite regénérer complètement l&rsquo;image et l&rsquo;importer dans les images de démarrage du WDS</strong></p><h3 id=limage-dinstallation>L&rsquo;image d&rsquo;installation</h3><p>Cette partie pose moins de problème et est plus classique. Il faut utiliser une image iso de Windows qui contient une version supérieure ou égale à celle décembre 2023.<br>Cette image est disponible sur le site de Microsoft.</p><h4 id=la-commande-dism-pour-vérifier-les-images>La commande DISM pour vérifier les images</h4><p>On vérifie à l&rsquo;iso monté en cd virtuel, la lettre du lecteur est à adapter en fonction de la situation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-batch data-lang=batch><span style=display:flex><span>dism /Get-WimInfo /WimFile:D:/sources/install.esd
</span></span></code></pre></div><p>Cette commande va afficher toutes les images d&rsquo;installation disponibles dans l&rsquo;image iso.</p><h4 id=convertir-le-fichier-installesd-en-installwim>Convertir le fichier install.esd en install.wim</h4><p>A partir de la partie précédente, il faut éxecuter la commande (adapter les chemins en fonction de la situation):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-batch data-lang=batch><span style=display:flex><span>dism /export-image /SourceImageFile:d:/sources/install.esd /SourceIndex:1 /DestinationImageFile:c:\install.wim /Compress:max /CheckIntegrity
</span></span></code></pre></div><p><a href=https://www.it-connect.fr/wds-convertir-un-fichier-esd-en-wim/>Lien vers la source</a></p><h4 id=import-de-limage-dans-le-mdt>Import de l&rsquo;image dans le MDT</h4><p>Il faut enfin importer l&rsquo;image dans le MDT via la console Deployment Workbench et modifier la séquence de tâches pour pointer vers le nouvel iso.</p><h4 id=les-problèmes-avec-laps>Les problèmes avec LAPS</h4><p>Un problème qui a été découvert, si un appareil est déployé avec un iso qui contient une version de Windows 10 qui date de fin 2023, le mot de passe administrateur peux poser des problème, la solution est de ne pas modifier les ordinateurs dans l&rsquo;AD lors du déploiement ou de mettre à jour les GPO de LAPS.</p><h2 id=les-autres-solutions-pour-ladk>Les autres solutions pour l&rsquo;ADK</h2><p>Il existe d&rsquo;autres moyens qui semblent marcher cependant ils peuvent prendre beaucoup de temps et être délicat à mettre en place:</p><ul><li><p>La première consiste à garder un ADK en version 2004 et à appliquer les mises à jour cumulatives à winPE pour avoir un winPE 2004 avec les mises à jour de Windows 10 22H2. Cette solution n&rsquo;a pas marché pour moi à cause d&rsquo;erreur lors du patch du winPE, quelques sources:</p><ul><li><a href=https://www.niallbrady.com/2023/11/23/problems-imaging-a-surface-go-4-using-configuration-manager/>lien 1 (guide de mise à jour)</a></li><li><a href="https://learn.microsoft.com/fr-fr/windows/deployment/customize-boot-image?tabs=powershell#updating-the-boot-image-and-boot-media-in-mdt">lien 2 (doc microsoft sur les images de démarrage)</a></li><li><a href=https://www.windows-noob.com/forums/topic/23351-problems-imaging-a-surface-go-4-using-configuration-manager/>lien 3 (guide de mise à jour)</a></li></ul></li><li><p>Une autre solution est de mettre à jour vers la dernière version de l&rsquo;ADK. Cette version est technique à mettre en place:</p><ul><li><p>Ce problème est crée à cause du retrait de la fonctionnalité VBSCRIPT dans l&rsquo;installation de Windows</p></li><li><p>Il faut récupérer dans une version Windows 11 insider preview (au moment de la publication originale de cette article, janvier 2024) les fichiers .cab de la fonctionnalité. Cette étape est très complexe, l&rsquo;installation doit être en 50 et 70% pour permettre la récupération des fichier et il faut le faire de préférence en VM ou en machine qui peux être redéployée.
Voici les commandes à utiliser:</p><ul><li>Vérifier si la fonctionnalité est disponible avec la commande:</li></ul><pre tabindex=0><code>DISM /online /get-capabilities
</code></pre><p>Il faut trouver la fonctionnalité: VBSCRIPT~~~~</p><ul><li>Ensuite, désinstaller la fonctionnalité:</li></ul><pre tabindex=0><code>DISM /online /remove-capability /capabilityname:VBSCRIPT~~~~
</code></pre><ul><li>On réinstalle ensuite la fonctionnalité:
DISM /online /add-capability /capabilityname:VBSCRIPT~~~~</li></ul></li><li><p>L&rsquo;explication de la manipulation à faire est disponible <a href=https://www.deploymentresearch.com/fixing-vbscript-support-in-windows-adk-sep-2023-update-build-25398/>ici</a></p></li></ul></li></ul></div></article><footer class=py:24><div class="f:fade-30 f:14 mb:8">copyright ©Loonaire</div><div class="f:fade-60 f:12">Theme <a class=f:bold href=https://github.com/serkodev/holy _target=_blank>Holy</a></div></footer></div></div></body></html>